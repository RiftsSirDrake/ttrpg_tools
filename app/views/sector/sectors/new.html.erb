<div class="container-fluid">
  <div class="pagetitle">
    <h1>New Sector</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><%= link_to "Sectors", sectors_path %></li>
        <li class="breadcrumb-item active">New</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Create New Sector</h5>

            <%= form_for @sector, url: sectors_path, html: { id: "sector-form", class: "row g-3" } do |f| %>
              <% if @sector.errors.any? %>
                <div class="col-12">
                  <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading"><%= pluralize(@sector.errors.count, "error") %> prohibited this sector from being saved:</h4>
                    <ul class="mb-0">
                      <% @sector.errors.full_messages.each do |message| %>
                        <li><%= message %></li>
                      <% end %>
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                </div>
              <% end %>

              <%= f.hidden_field :author, value: current_user.email %>
              <%= f.hidden_field :created_at, value: Time.now %>
              <%= f.hidden_field :updated_at, value: Time.now %>

              <div class="col-12">
                <%= f.label :name, class: "form-label" %>
                <%= f.text_field :name, class: 'form-control', placeholder: "Enter sector name" %>
              </div>

              <div class="col-12 mt-3">
                <%= f.label :hex_color, "Hexmap Background Color", class: "form-label" %>
                <%= f.color_field :hex_color, value: "#f8f9fa", class: 'form-control form-control-color', title: "Choose hexmap background color" %>
                <div class="form-text">Choose the background color for the hexagons on the hexmap. Default is #f8f9fa.</div>
              </div>

              <div class="col-12 mt-3">
                <%= f.label :background_image, "Sector Background Image", class: "form-label" %>
                <%= f.select :background_image, 
                    options_for_select([["None", nil]] + Dir.glob(Rails.root.join('app', 'assets', 'images', 'backgrounds', '*.svg')).map { |f| [File.basename(f, '.svg').titleize, File.basename(f)] }, @sector.background_image), 
                    {}, { class: "form-select" } %>
                <div class="form-text">Choose a background image for the entire sector map.</div>
              </div>

              <div class="col-md-6 mt-3">
                <%= f.label :border_width, "Border Thickness (px)", class: "form-label" %>
                <%= f.number_field :border_width, value: 4, class: 'form-control', min: 0, max: 20, step: 1 %>
                <div class="form-text">Thickness of faction boundaries. Default is 4.</div>
              </div>

              <div class="col-md-6 mt-3">
                <%= f.label :border_opacity, "Border Opacity (0-1)", class: "form-label" %>
                <%= f.number_field :border_opacity, value: 0.5, class: 'form-control', min: 0, max: 1, step: 0.05 %>
                <div class="form-text">Transparency of faction boundaries. Default is 0.5.</div>
              </div>

              <div class="col-12 mt-3">
                <div class="form-check form-switch">
                  <%= f.check_box :public_view, class: 'form-check-input' %>
                  <%= f.label :public_view, "Open To Public?", class: "form-check-label" %>
                </div>
                <div class="form-text">If enabled, any user can view this sector.</div>
              </div>

              <div class="text-center mt-4">
                <%= f.submit "Create Sector", class: 'btn btn-primary' %>
                <button type="button" id="reload-preview" class="btn btn-outline-info">
                  <i class="bi bi-arrow-clockwise"></i> Reload Preview
                </button>
                <%= link_to 'Cancel', sectors_path, class: "btn btn-secondary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Hexmap Preview</h5>
            <div id="hexmap-preview" style="min-height: 400px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"></div>
            <div class="form-text mt-2">
              <i class="bi bi-info-circle"></i> This is a sample preview showing how your color and border settings will appear on the actual hexmap.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var data = gon.data;
    var previewContainer = document.getElementById('hexmap-preview');
    var hex;

    function getNeighbor(q, r, e) {
      var isEven = (q % 2 === 0);
      switch (e) {
        case 1: return { q: q, r: r + 1 };
        case 2: return isEven ? { q: q + 1, r: r } : { q: q + 1, r: r + 1 };
        case 3: return isEven ? { q: q + 1, r: r - 1 } : { q: q + 1, r: r };
        case 4: return { q: q, r: r - 1 };
        case 5: return isEven ? { q: q - 1, r: r - 1 } : { q: q - 1, r: r };
        case 6: return isEven ? { q: q - 1, r: r } : { q: q - 1, r: r + 1 };
      }
    }

    function calculateBoundaries(hexes) {
      var boundaries = {};
      var coordMap = {};
      for (var id in hexes) {
        var h = hexes[id];
        coordMap[h.q + "," + h.r] = h.allegiance;
      }

      for (var id in hexes) {
        var h = hexes[id];
        var allegiance = h.allegiance;
        if (!allegiance) continue;

        if (!boundaries[allegiance]) {
          boundaries[allegiance] = { edges: [], color: h.colour };
        }

        for (var e = 1; e <= 6; e++) {
          var neighbor = getNeighbor(h.q, h.r, e);
          if (coordMap[neighbor.q + "," + neighbor.r] !== allegiance) {
            boundaries[allegiance].edges.push({ q: h.q, r: h.r, e: e });
          }
        }
      }
      return boundaries;
    }

    function renderHexmap() {
      // Clear existing content
      previewContainer.innerHTML = '';
      
      if (!data) return;

      var hexjson = {
        "layout": "odd-q",
        "hexes": data,
        "boundaries": calculateBoundaries(data)
      };

      var hexColorInput = document.querySelector('[name*="[hex_color]"]');
      var borderWidthInput = document.querySelector('[name*="[border_width]"]');
      var borderOpacityInput = document.querySelector('[name*="[border_opacity]"]');
      var backgroundImageInput = document.querySelector('[name*="[background_image]"]');

      var hexColor = hexColorInput ? hexColorInput.value : "#f8f9fa";
      var borderWidth = (borderWidthInput && borderWidthInput.value !== "") ? parseInt(borderWidthInput.value) : 4;
      var borderOpacity = (borderOpacityInput && borderOpacityInput.value !== "") ? parseFloat(borderOpacityInput.value) : 0.5;
      var backgroundImage = backgroundImageInput ? backgroundImageInput.value : "";

      hex = new OI.hexmap(previewContainer, {
        'grid': {'show': true},
        'hexjson': hexjson,
        'label': {
          'show': true,
          'clip': true,
          'format': function(txt, attr) {
            return '<tspan class="off">' + txt.substr(0, 3) + '</tspan>';
          }
        },
        'ready': function() {
          if (backgroundImage && gon.background_images && gon.background_images[backgroundImage]) {
            var backgroundUrl = gon.background_images[backgroundImage];
            this.el.style.backgroundImage = "url('" + backgroundUrl + "')";
            this.el.style.backgroundSize = "cover";
            this.el.style.backgroundPosition = "center";
            this.el.style.backgroundRepeat = "no-repeat";
          }

          this.updateBoundaries(function(n, props) {
            return {
              'stroke': props.color || 'black',
              'stroke-width': borderWidth,
              'opacity': borderOpacity,
              'stroke-linecap': 'round'
            };
          });
          this.updateColours(function(r) {
            return hexColor;
          });
        }
      });
    }

    // Initial render
    renderHexmap();

    // Reload button
    document.getElementById('reload-preview').addEventListener('click', function() {
      renderHexmap();
    });
  });
</script>
