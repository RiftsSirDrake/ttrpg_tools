<%= form_for @system, url: @system.persisted? ? system_path(@system) : systems_path, html: { class: "row g-3" } do |f| %>

  <% if @system.errors.any? %>
    <div class="col-12">
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h4 class="alert-heading"><%= pluralize(@system.errors.count, "error") %> prohibited this system from being saved:</h4>
        <ul class="mb-0">
          <% @system.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </div>
  <% end %>

  <%= f.hidden_field :sector_id, value: @sector.id %>

  <div class="col-md-6">
    <%= f.label :name, class: "form-label" %>
    <%= f.text_field :name, maxlength: 45, class: 'form-control', placeholder: "System Name" %>
  </div>

  <div class="col-md-6">
    <%= f.label :location, class: "form-label" %> <small class="text-muted">(Ex. 0301)</small>
    <%= f.number_field :location, class: 'form-control', placeholder: "Hex Location" %>
  </div>

  <div class="col-md-4">
    <%= f.label :starport, "Starport", class: "form-label" %>
    <%= f.select :starport, options_for_select(Shared::SystemMapping::PORT_MAP.map { |k, v| [v, k] }, selected: @system.uwp[0]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :planet_size, "Planet Size", class: "form-label" %>
    <%= f.select :planet_size, options_for_select(Shared::SystemMapping::SIZE_MAP.map { |k, v| [v, k] }, selected: @system.uwp[1]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :atmosphere, "Atmosphere", class: "form-label" %>
    <%= f.select :atmosphere, options_for_select(Shared::SystemMapping::ATMO_MAP.map { |k, v| [v, k] }, selected: @system.uwp[2]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :hydrosphere, "Hydrosphere", class: "form-label" %>
    <%= f.select :hydrosphere, options_for_select(Shared::SystemMapping::HYDRO_MAP.map { |k, v| [v, k] }, selected: @system.uwp[3]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-8">
    <div id="population" class="row">
      <div class="col-md-6">
        <%= f.label :pop_base, "Population Multiplier", class: "form-label" %>
        <%= f.select :pop_base, options_for_select((0..9).to_a, @system.pbg[0]), {}, { class: 'form-select' } %>
      </div>
      <div class="col-md-6">
        <%= f.label :population, "Population Exponent", class: "form-label" %>
        <%= f.select :population, options_for_select(Shared::SystemMapping::POP_MAP.map { |k, v| [v.call(@system.pbg[0]), k] }, selected: @system.uwp[4]), {}, { class: "form-select" } %>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <%= f.label :goverment, "Government", class: "form-label" %>
    <%= f.select :goverment, options_for_select(Shared::SystemMapping::GOV_MAP.map { |k, v| [v, k] }, selected: @system.uwp[5]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :law, "Law Level", class: "form-label" %>
    <%= f.select :law, options_for_select(Shared::SystemMapping::LAW_MAP.map { |k, v| [v, k] }, selected: @system.uwp[6]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :tech_level, "Tech Level", class: "form-label" %>
    <%= f.select :tech_level, options_for_select(Shared::SystemMapping::TECH_MAP.map { |k, v| [v, k] }, selected: @system.uwp[8]), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :base, "Bases", class: "form-label" %>
    <%= f.select :base, options_for_select(Shared::SystemMapping::BASES_MAP.map { |k, v| [v, k] },selected: @system.base), { include_blank: true }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :ring, "Travel Advisory", class: "form-label" %>
    <%= f.select :ring, options_for_select(Shared::SystemMapping::ADVISORY_MAP.map { |k, v| [v, k] }, selected: @system.ring), {}, { class: "form-select" } %>
  </div>

  <div class="col-md-2">
    <%= f.label :asteroid_belts, "Asteroid Belts", class: "form-label" %>
    <%= f.select :asteroid_belts, options_for_select((0..9).to_a, @system.pbg[1]), {}, { class: 'form-select' } %>
  </div>

  <div class="col-md-2">
    <%= f.label :gas_giants, "Gas Giants", class: "form-label" %>
    <%= f.select :gas_giants, options_for_select((0..9).to_a, @system.pbg[2]), {}, { class: 'form-select' } %>
  </div>

  <div class="col-md-4">
    <%= f.label :notes1, "Note 1", class: "form-label" %>
    <%= f.select :notes1, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[0,2]), { include_blank: true },  { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :notes2, "Note 2", class: "form-label" %>
    <%= f.select :notes2, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[3,2]), { include_blank: true }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= f.label :notes3, "Note 3", class: "form-label" %>
    <%= f.select :notes3, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[6,2]), { include_blank: true }, { class: "form-select" } %>
  </div>

  <div class="col-12 mt-3 pt-3 border-top">
    <%= f.label :allegiance, "Faction Allegiance", class: "form-label" %>
    <div class="input-group">
      <%= f.select :allegiance, options_for_select(@factions.map { |fac| [fac.name, fac.name] }, selected: @system.allegiance), { include_blank: "No Allegiance" }, { class: "form-select", id: "faction_select" } %>
      <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newFactionModal">
        <i class="bi bi-plus-circle"></i> New Faction
      </button>
    </div>
  </div>

  <div class="text-center mt-4">
    <%= f.submit class: 'btn btn-primary px-4' %>
    <%= link_to 'Cancel', systems_path(sector_id: @sector.id), class: "btn btn-secondary px-4" %>
  </div>

<% end %>

<!-- Modal -->
<div class="modal fade" id="newFactionModal" tabindex="-1" aria-labelledby="newFactionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newFactionModalLabel">New Faction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: SectorModel::Faction.new, url: factions_path, id: "new_faction_form", local: false do |f| %>
          <%= f.hidden_field :sector_id, value: @sector.id %>
          <div class="mb-3">
            <%= f.label :name, class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true %>
          </div>
          <div class="mb-3">
            <%= f.label :description, class: "form-label" %>
            <%= f.text_area :description, class: "form-control" %>
          </div>
          <div class="mb-3">
            <%= f.label :color_code, class: "form-label" %>
            <%= f.text_field :color_code, id: 'color_picker_modal', class: "form-control" %>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveFactionBtn">Save Faction</button>
      </div>
    </div>
  </div>
</div>

<script>

  $(document).ready(function(){
      $('#color_picker_modal').spectrum({
          preferredFormat: "rgb",
          showInput: true
      });

      $('#saveFactionBtn').on('click', function() {
          var btn = $(this);
          var form = $('#new_faction_form');
          
          if (!form[0].checkValidity()) {
              form[0].reportValidity();
              return;
          }

          btn.prop('disabled', true);
          btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
          
          $.ajax({
              url: form.attr('action'),
              method: 'POST',
              data: form.serialize(),
              dataType: 'json',
              success: function(data) {
                  if (data && data.name) {
                      var newOption = new Option(data.name, data.name, true, true);
                      $('#faction_select').append(newOption).trigger('change');
                  } else {
                      console.error("No faction data received or name missing", data);
                  }
                  
                  closeFactionModal();
                  form[0].reset();
                  
                  if ($.fn.spectrum) {
                      $('#color_picker_modal').spectrum('set', '');
                  }
                  btn.prop('disabled', false).text('Save Faction');
              },
              error: function(xhr, status, error) {
                  console.error('Error creating faction:', error);
                  alert('Error creating faction');
                  btn.prop('disabled', false).text('Save Faction');
              }
          });
      });

      function closeFactionModal() {
          var modalElement = document.getElementById('newFactionModal');
          
          // Use Bootstrap 5 API explicitly
          if (window.bootstrap && bootstrap.Modal) {
              var modal = bootstrap.Modal.getInstance(modalElement);
              if (!modal) {
                  modal = new bootstrap.Modal(modalElement);
              }
              modal.hide();
          } else if (typeof $(modalElement).modal === 'function') {
              $(modalElement).modal('hide');
          }
          
          // Fallback if bootstrap modal doesn't close properly
          setTimeout(function() {
            if ($('.modal-backdrop').length > 0) {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
                $('body').css('overflow', '');
                $('body').css('padding-right', '');
            }
          }, 500);
      }

      $('#population').on('change', '#sector_model_system_pop_base', function(){
        var pop_base_value = $(this).val();
        if (pop_base_value !== '0') {
          $('#sector_model_system_population option').each(function(){
            var pop_value = $(this).val();
            if (pop_value !== '0') {
              $(this).text(pop_base_value + $(this).text().substring(1, $(this).text().length));
            }
          });
        } else {
          $('#sector_model_system_population').val("0")
        }
        });
      });

</script>