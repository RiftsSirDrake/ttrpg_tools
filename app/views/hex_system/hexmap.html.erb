<% content_for :page_title, "Hexmap - #{@sector.name}" %>

<div class="container-fluid">
  <div class="pagetitle">
    <h1>Hexmap - <%= @sector.name %></h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
        <li class="breadcrumb-item"><%= link_to "Sectors", sectors_path %></li>
        <li class="breadcrumb-item"><%= link_to @sector.name, sector_path(@sector) %></li>
        <li class="breadcrumb-item active">Hexmap</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">

      <div class="col-lg-9">
        <% if @organized_data.present? %>
          <div class="card">
            <div class="card-body pt-3">
              <div id="hexmap"></div>
            </div>
          </div>
        <% else %>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">No Systems Found</h5>
              <p>There are no systems to display in this sector. You can add systems via the <%= link_to "Systems", systems_path(sector_id: @sector.id) %> page.</p>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Legend</h5>
            <div class="table-responsive">
              <table class="table table-hover table-sm align-middle">
                <thead>
                  <tr>
                    <th>Faction</th>
                    <th class="text-center">Flag</th>
                  </tr>
                </thead>
                <tbody>
                  <% @factions.order(:name).each do |faction| %>
                    <tr>
                      <td><span class="small fw-bold"><%= faction.name %></span></td>
                      <td class="text-center">
                        <i class="bi bi-flag-fill fs-4" style="color: <%= faction.color_code %>;" title="<%= faction.color_code %>"></i>
                      </td>
                    </tr>
                  <% end %>
                  <% if @factions.blank? %>
                    <tr>
                      <td colspan="2" class="text-center text-muted small">No factions defined</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Actions</h5>
            <div class="d-grid gap-2">
              <%= link_to factions_path(sector_id: @sector.id), class: "btn btn-outline-info btn-sm" do %>
                <i class="bi bi-people"></i> View Factions
              <% end %>
              <%= link_to systems_path(sector_id: @sector.id), class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-layers"></i> View Systems
              <% end %>
              <%= link_to sector_path(@sector), class: "btn btn-outline-secondary btn-sm" do %>
                <i class="bi bi-globe"></i> Sector Details
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>


<% if @organized_data.present? %>
<script>
	var data = gon.data

  function getNeighbor(q, r, e) {
    var isEven = (q % 2 === 0);
    switch (e) {
      case 1: return { q: q, r: r + 1 }; // Top
      case 2: return isEven ? { q: q + 1, r: r } : { q: q + 1, r: r + 1 }; // Top-Right
      case 3: return isEven ? { q: q + 1, r: r - 1 } : { q: q + 1, r: r }; // Bottom-Right
      case 4: return { q: q, r: r - 1 }; // Bottom
      case 5: return isEven ? { q: q - 1, r: r - 1 } : { q: q - 1, r: r }; // Bottom-Left
      case 6: return isEven ? { q: q - 1, r: r } : { q: q - 1, r: r + 1 }; // Top-Left
    }
  }

  function calculateBoundaries(hexes) {
    var boundaries = {};
    var coordMap = {};
    for (var id in hexes) {
      var h = hexes[id];
      coordMap[h.q + "," + h.r] = h.allegiance;
    }

    for (var id in hexes) {
      var h = hexes[id];
      var allegiance = h.allegiance;
      if (!allegiance) continue;

      if (!boundaries[allegiance]) {
        boundaries[allegiance] = { edges: [], color: h.colour };
      }

      for (var e = 1; e <= 6; e++) {
        var neighbor = getNeighbor(h.q, h.r, e);
        if (coordMap[neighbor.q + "," + neighbor.r] !== allegiance) {
          boundaries[allegiance].edges.push({ q: h.q, r: h.r, e: e });
        }
      }
    }
    return boundaries;
  }

  var hexjson = {
    "layout": "odd-q",
    "hexes": data,
    "boundaries": calculateBoundaries(data)
  };

	hex = new OI.hexmap(document.getElementById('hexmap'),{
		'grid': {'show':true},
		// The HexJSON layout
		'hexjson': hexjson,
		'label':{
			'show': true,	// Show a label
			'clip': true,	// Make sure the label is clipped to the hexagon
			// Define a function to format the hex labels
			// It is passed:
			//  * txt - a text string with the hex's name
			//  * attr - an object containing:
			//		* size - the size in pixels
			//		* font-size - the font size in pixels
			//		* x - the horizontal position in pixels
			//		* y - the vertical position in pixels
			//		* hex - the hexagon's HexJSON properties
			'format': function(txt,attr){
				tspans = '<tspan class="off">'+txt.substr(0,3)+'</tspan>';
				lines = txt.split(/ /);
				lines.push(attr.hex.hex_loc.toLocaleString());
				return tspans;
			}
		},
    'ready': function() {
      this.updateBoundaries(function(n, props) {
        return {
          'stroke': props.color || 'black',
          'stroke-width': gon.border_width,
          'opacity': gon.border_opacity,
          'stroke-linecap': 'round'
        };
      });
      this.updateColours(function(r) {
        return gon.hex_color;
      });
    }
	});

  // Make a tooltip
  hex.on('mouseover',function(e){
  	var container,tip,bb,bbo,hex_el,path_el;
  	container = e.data.hexmap.el || e.data.hexmap._attr.el; // Use inner element or fallback to main element
  	hex_el = e.currentTarget; // Use currentTarget to get the hex group
  	path_el = hex_el.querySelector('path'); // Use the path element for precise bounding box
  	
  	// Get any existing tooltip for this hexmap
  	tip = container.querySelector('.hex-tip');
  	if(!tip){
  		// Add a new tooltip
  		tip = document.createElement('div');
  		tip.classList.add('hex-tip');
  		container.appendChild(tip);
  	}
  	// Update contents of tooltip
  	tip.innerHTML = '<strong><a href="/systems/'+e.data.data.sys_id+'" style="color: #4db3ff;">'+e.data.data.n+'</a></strong>'+
  	  '<br />'+'Traveller Coordinates '+e.data.data.hex_loc.toLocaleString()+
  	  '<br /> Hexmap Coordinates q:'+e.data.data.q+' r:'+e.data.data.r;
  	
  	// Update position of tooltip
  	bb = (path_el || hex_el).getBoundingClientRect();
  	bbo = container.getBoundingClientRect();

    // Account for any scaling (e.g. browser zoom or CSS transforms)
    var scaleX = bbo.width / container.offsetWidth || 1;
    var scaleY = bbo.height / container.offsetHeight || 1;
  	
  	var left = (bb.left + bb.width/2 - bbo.left) / scaleX - container.clientLeft;
  	var top = (bb.top - bbo.top) / scaleY - container.clientTop - 10; // Position above the hex
  	
  	tip.style.left = Math.round(left)+'px';
  	tip.style.top = Math.round(top)+'px';
  });

</script>
<% end %>