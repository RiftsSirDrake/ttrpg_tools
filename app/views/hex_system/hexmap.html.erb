<% content_for :page_title, "Hexmap - #{@sector.name}" %>

<div class="container-fluid">
  <div class="pagetitle">
    <h1>Hexmap - <%= @sector.name %></h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
        <li class="breadcrumb-item"><%= link_to "Sectors", sectors_path %></li>
        <li class="breadcrumb-item"><%= link_to @sector.name, sector_path(@sector) %></li>
        <li class="breadcrumb-item active">Hexmap</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">

      <div class="col-lg-9">
        <% if @organized_data.present? %>
          <div class="card">
            <div class="card-body pt-3">
              <div id="hexmap"></div>
            </div>
          </div>
        <% else %>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">No Systems Found</h5>
              <p>There are no systems to display in this sector. You can add systems via the <%= link_to "Systems", systems_path(sector_id: @sector.id) %> page.</p>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Legend</h5>
            <div class="table-responsive">
              <table class="table table-hover table-sm align-middle">
                <thead>
                  <tr>
                    <th>Faction</th>
                    <th class="text-center">Flag</th>
                  </tr>
                </thead>
                <tbody>
                  <% @factions.order(:name).each do |faction| %>
                    <tr>
                      <td><span class="small fw-bold"><%= faction.name %></span></td>
                      <td class="text-center">
                        <i class="bi bi-flag-fill fs-4" style="color: <%= faction.color_code %>;" title="<%= faction.color_code %>"></i>
                      </td>
                    </tr>
                  <% end %>
                  <% if @factions.blank? %>
                    <tr>
                      <td colspan="2" class="text-center text-muted small">No factions defined</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Actions</h5>
            <% if can_edit_systems?(@sector, current_user) %>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="editModeToggle">
                <label class="form-check-label" for="editModeToggle">Edit Factions Mode</label>
              </div>
            <% end %>
            <div class="d-grid gap-2">
              <%= link_to factions_path(sector_id: @sector.id), class: "btn btn-outline-info btn-sm" do %>
                <i class="bi bi-people"></i> View Factions
              <% end %>
              <%= link_to systems_path(sector_id: @sector.id), class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-layers"></i> View Systems
              <% end %>
              <%= link_to sector_path(@sector), class: "btn btn-outline-secondary btn-sm" do %>
                <i class="bi bi-globe"></i> Sector Details
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Faction Edit Modal -->
<% if can_edit_systems?(@sector, current_user) %>
<div class="modal fade" id="editFactionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change System Faction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editFactionForm">
          <input type="hidden" id="modalSystemId" name="system_id">
          <div class="mb-3">
            <label class="form-label">System</label>
            <input type="text" id="modalSystemName" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label for="modalFactionSelect" class="form-label">New Faction</label>
            <div class="input-group">
              <select class="form-select" id="modalFactionSelect" name="allegiance">
                <option value="">Independent</option>
                <% @factions.order(:name).each do |faction| %>
                  <option value="<%= faction.name %>"><%= faction.name %></option>
                <% end %>
              </select>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newFactionModal">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <%= link_to "#", id: "viewSystemBtn", class: "btn btn-outline-info me-auto" do %>
          <i class="bi bi-eye"></i> View Details
        <% end %>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveFactionBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- New Faction Modal -->
<% if can_edit_factions?(@sector, current_user) %>
<div class="modal fade" id="newFactionModal" tabindex="-1" aria-labelledby="newFactionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newFactionModalLabel">New Faction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: SectorModel::Faction.new, url: factions_path, id: "new_faction_form", local: false do |f| %>
          <%= f.hidden_field :sector_id, value: @sector.id %>
          <div class="mb-3">
            <%= f.label :name, class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true %>
          </div>
          <div class="mb-3">
            <%= f.label :description, class: "form-label" %>
            <%= f.text_area :description, class: "form-control" %>
          </div>
          <div class="mb-3">
            <%= f.label :color_code, class: "form-label" %>
            <%= f.text_field :color_code, id: 'color_picker_modal', class: "form-control" %>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveNewFactionBtn">Save Faction</button>
      </div>
    </div>
  </div>
</div>
<% end %>


<% if @organized_data.present? %>
<script>
	var data = gon.data

  function getNeighbor(q, r, e) {
    var isEven = (q % 2 === 0);
    switch (e) {
      case 1: return { q: q, r: r + 1 }; // Top
      case 2: return isEven ? { q: q + 1, r: r } : { q: q + 1, r: r + 1 }; // Top-Right
      case 3: return isEven ? { q: q + 1, r: r - 1 } : { q: q + 1, r: r }; // Bottom-Right
      case 4: return { q: q, r: r - 1 }; // Bottom
      case 5: return isEven ? { q: q - 1, r: r - 1 } : { q: q - 1, r: r }; // Bottom-Left
      case 6: return isEven ? { q: q - 1, r: r } : { q: q - 1, r: r + 1 }; // Top-Left
    }
  }

  function calculateBoundaries(hexes) {
    var boundaries = {};
    var coordMap = {};
    for (var id in hexes) {
      var h = hexes[id];
      coordMap[h.q + "," + h.r] = h.allegiance;
    }

    for (var id in hexes) {
      var h = hexes[id];
      var allegiance = h.allegiance;
      if (!allegiance) continue;

      if (!boundaries[allegiance]) {
        boundaries[allegiance] = { edges: [], color: h.colour };
      }

      for (var e = 1; e <= 6; e++) {
        var neighbor = getNeighbor(h.q, h.r, e);
        if (coordMap[neighbor.q + "," + neighbor.r] !== allegiance) {
          boundaries[allegiance].edges.push({ q: h.q, r: h.r, e: e });
        }
      }
    }
    return boundaries;
  }

  var hexjson = {
    "layout": "odd-q",
    "hexes": data,
    "boundaries": calculateBoundaries(data)
  };

  function mapReady() {
    if (gon.background_image && gon.background_images && gon.background_images[gon.background_image]) {
      var backgroundUrl = gon.background_images[gon.background_image];
      this.el.style.backgroundImage = "url('" + backgroundUrl + "')";
      this.el.style.backgroundSize = "cover";
      this.el.style.backgroundPosition = "center";
      this.el.style.backgroundRepeat = "no-repeat";
    }
    this.updateBoundaries(function(n, props) {
      return {
        'stroke': props.color || (document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#444' : 'black'),
        'stroke-width': gon.border_width,
        'opacity': gon.border_opacity,
        'stroke-linecap': 'round'
      };
    });
    this.updateColours(function(r) {
      return gon.hex_color;
    });
  }

	hex = new OI.hexmap(document.getElementById('hexmap'),{
		'grid': {'show':<%= @sector.show_grid %>},
    'style': {
      'grid': { 'fill-opacity': <%= @sector.grid_opacity.presence || 0.1 %> }
    },
		// The HexJSON layout
		'hexjson': hexjson,
		'label':{
			'show': true,	// Show a label
			'clip': true,	// Make sure the label is clipped to the hexagon
			// Define a function to format the hex labels
			// It is passed:
			//  * txt - a text string with the hex's name
			//  * attr - an object containing:
			//		* size - the size in pixels
			//		* font-size - the font size in pixels
			//		* x - the horizontal position in pixels
			//		* y - the vertical position in pixels
			//		* hex - the hexagon's HexJSON properties
			'format': function(txt,attr){
				tspans = '<tspan class="off">'+txt.substr(0,3)+'</tspan>';
				lines = txt.split(/ /);
				lines.push(attr.hex.hex_loc.toLocaleString());
				return tspans;
			}
		},
    'ready': mapReady
	});

  // Make a tooltip
  hex.on('mouseover',function(e){
  	var container,tip,bb,bbo,hex_el,path_el;
  	container = e.data.hexmap.el || e.data.hexmap._attr.el; // Use inner element or fallback to main element
  	hex_el = e.currentTarget; // Use currentTarget to get the hex group
  	path_el = hex_el.querySelector('path'); // Use the path element for precise bounding box
  	
  	// Get any existing tooltip for this hexmap
  	tip = container.querySelector('.hex-tip');
  	if(!tip){
  		// Add a new tooltip
  		tip = document.createElement('div');
  		tip.classList.add('hex-tip');
  		container.appendChild(tip);
  	}

    var hex_data = e.data.data;
    var faction_color = hex_data.colour || '#4db3ff';
    var starport_short = hex_data.starport ? hex_data.starport.split('-')[0].trim() : 'Unknown';
    var advisory_text = hex_data.advisory && !hex_data.advisory.startsWith('None') ? 
                        '<div class="mt-1 text-danger fw-bold"><i class="bi bi-exclamation-triangle"></i> ' + hex_data.advisory + '</div>' : '';

  	// Update contents of tooltip with Bootstrap Card styling
  	tip.innerHTML = 
      '<div class="card shadow-sm border-0" style="min-width: 200px; overflow: hidden;">' +
        '<div class="card-header py-1 px-2 text-white" style="background-color: ' + faction_color + ';">' +
          '<h6 class="mb-0 fw-bold">' + hex_data.n + ' <small class="opacity-75">(' + hex_data.hex_loc + ')</small></h6>' +
        '</div>' +
        '<div class="card-body p-2 small">' +
          '<div class="mb-1"><strong><i class="bi bi-flag"></i> Faction:</strong> ' + (hex_data.allegiance || 'None') + '</div>' +
          '<div class="mb-1"><strong><i class="bi bi-fuel-pump"></i> Port:</strong> ' + starport_short + '</div>' +
          '<div class="mb-1"><strong><i class="bi bi-tools"></i> Tech Level:</strong> ' + (hex_data.tech_level || 'N/A') + '</div>' +
          '<div class="mb-1"><strong><i class="bi bi-people"></i> Population:</strong> ' + (hex_data.population || 'Unknown') + '</div>' +
          advisory_text +
        '</div>' +
      '</div>';
  	
  	// Update position of tooltip
  	bb = (path_el || hex_el).getBoundingClientRect();
  	bbo = container.getBoundingClientRect();

    // Account for any scaling (e.g. browser zoom or CSS transforms)
    var scaleX = bbo.width / container.offsetWidth || 1;
    var scaleY = bbo.height / container.offsetHeight || 1;
  	
  	var left = (bb.left + bb.width/2 - bbo.left) / scaleX - container.clientLeft;
  	var top = (bb.top - bbo.top) / scaleY - container.clientTop - 5; // Position above the hex
  	
  	tip.style.left = Math.round(left)+'px';
  	tip.style.top = Math.round(top)+'px';
    tip.style.transform = 'translateX(-50%) translateY(-100%)';
    tip.style.position = 'absolute';
    tip.style.zIndex = '1050';
    tip.style.display = 'block'; // Ensure it's visible when hovering
  });

  // Hide tooltip on mouseout
  hex.on('mouseout', function(e) {
    var container = e.data.hexmap.el || e.data.hexmap._attr.el;
    var tip = container.querySelector('.hex-tip');
    if (tip) {
      tip.style.display = 'none';
    }
  });

  // Handle click on hex to navigate or edit
  hex.on('click', function(e) {
    var sys_id = e.data.data.sys_id;
    var sys_name = e.data.data.n;
    var allegiance = e.data.data.allegiance;
    var editMode = document.getElementById('editModeToggle') && document.getElementById('editModeToggle').checked;
    
    if (gon.can_edit && editMode) {
      // Show edit modal
      var modal = new bootstrap.Modal(document.getElementById('editFactionModal'));
      document.getElementById('modalSystemId').value = sys_id;
      document.getElementById('modalSystemName').value = sys_name;
      document.getElementById('modalFactionSelect').value = allegiance || "";
      
      // Update the "View Details" button URL
      var viewBtn = document.getElementById('viewSystemBtn');
      if (viewBtn) {
        viewBtn.href = '/systems/' + sys_id;
      }
      
      modal.show();
    } else if (sys_id) {
      window.location.href = '/systems/' + sys_id;
    }
  });

  if (gon.can_edit) {
    // Initialize color picker for the new faction modal
    if ($.fn.spectrum) {
      $('#color_picker_modal').spectrum({
          preferredFormat: "rgb",
          showInput: true
      });
    }

    // Handle new faction creation
    var saveNewFactionBtn = document.getElementById('saveNewFactionBtn');
    if (saveNewFactionBtn) {
      saveNewFactionBtn.addEventListener('click', function() {
        var btn = $(this);
        var form = $('#new_faction_form');
        
        if (!form[0].checkValidity()) {
            form[0].reportValidity();
            return;
        }

        btn.prop('disabled', true);
        btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
        
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            dataType: 'json',
            success: function(data) {
                if (data && data.name) {
                    var newOption = new Option(data.name, data.name, true, true);
                    $('#modalFactionSelect').append(newOption).trigger('change');
                }
                
                // Close the new faction modal
                var modalElement = document.getElementById('newFactionModal');
                var modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) modal = new bootstrap.Modal(modalElement);
                modal.hide();

                form[0].reset();
                if ($.fn.spectrum) {
                    $('#color_picker_modal').spectrum('set', '');
                }
                btn.prop('disabled', false).text('Save Faction');
            },
            error: function(xhr, status, error) {
                console.error('Error creating faction:', error);
                alert('Error creating faction');
                btn.prop('disabled', false).text('Save Faction');
            }
        });
      });
    }

    document.getElementById('saveFactionBtn').addEventListener('click', function() {
      var btn = this;
      var sys_id = document.getElementById('modalSystemId').value;
      var new_allegiance = document.getElementById('modalFactionSelect').value;
      
      btn.disabled = true;
      var originalContent = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

      fetch('/systems/' + sys_id + '/update_allegiance', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ allegiance: new_allegiance })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          // Update local data
          var updated = false;
          for (var id in data) {
            if (data[id].sys_id == sys_id) {
              data[id].allegiance = result.allegiance;
              data[id].colour = result.color;
              updated = true;
              break;
            }
          }
          
          if (updated) {
            hexjson.boundaries = calculateBoundaries(data);
            hex.load(hexjson, mapReady);
          }

          // Close modal
          var modalElement = document.getElementById('editFactionModal');
          var modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) modal.hide();
        } else {
          alert('Error: ' + (result.errors ? result.errors.join(', ') : result.error));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving.');
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      });
    });
  }

</script>
<% end %>