<% content_for :page_title, "Hexmap - #{@sector.name}" %>

<div class="container-fluid">
  <div class="pagetitle">
    <h1>Hexmap - <%= @sector.name %></h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
        <li class="breadcrumb-item"><%= link_to "Sectors", sectors_path %></li>
        <li class="breadcrumb-item"><%= link_to @sector.name, sector_path(@sector) %></li>
        <li class="breadcrumb-item active">Hexmap</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">

      <div class="col-lg-9">
        <% if @organized_data.present? %>
          <div class="card">
            <div class="card-body pt-3">
              <div id="hexmap"></div>
            </div>
          </div>
        <% else %>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">No Systems Found</h5>
              <p>There are no systems to display in this sector. You can add systems via the <%= link_to "Systems", systems_path(sector_id: @sector.id) %> page.</p>
            </div>
          </div>
        <% end %>
      </div>

      <div class="col-lg-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Legend</h5>
            <div class="table-responsive">
              <table class="table table-hover table-sm align-middle">
                <thead>
                  <tr>
                    <th>Faction</th>
                    <th class="text-center">Flag</th>
                  </tr>
                </thead>
                <tbody>
                  <% @factions.order(:name).each do |faction| %>
                    <tr>
                      <td><span class="small fw-bold"><%= faction.name %></span></td>
                      <td class="text-center">
                        <i class="bi bi-flag-fill fs-4" style="color: <%= faction.color_code %>;" title="<%= faction.color_code %>"></i>
                      </td>
                    </tr>
                  <% end %>
                  <% if @factions.blank? %>
                    <tr>
                      <td colspan="2" class="text-center text-muted small">No factions defined</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Actions</h5>
            <div class="d-grid gap-2">
              <%= link_to systems_path(sector_id: @sector.id), class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-layers"></i> View Systems
              <% end %>
              <%= link_to sector_path(@sector), class: "btn btn-outline-secondary btn-sm" do %>
                <i class="bi bi-globe"></i> Sector Details
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>


<% if @organized_data.present? %>
<script>
	var data = gon.data
	hex = new OI.hexmap(document.getElementById('hexmap'),{
		// The HexJSON layout
		'hexjson':{
			"layout":"odd-q",
			"hexes": data
		},
		'label':{
			'show': true,	// Show a label
			'clip': true,	// Make sure the label is clipped to the hexagon
			// Define a function to format the hex labels
			// It is passed:
			//  * txt - a text string with the hex's name
			//  * attr - an object containing:
			//		* size - the size in pixels
			//		* font-size - the font size in pixels
			//		* x - the horizontal position in pixels
			//		* y - the vertical position in pixels
			//		* hex - the hexagon's HexJSON properties
			'format': function(txt,attr){
				tspans = '<tspan class="off">'+txt.substr(0,3)+'</tspan>';
				lines = txt.split(/ /);
				lines.push(attr.hex.hex_loc.toLocaleString());
				return tspans;
			}
		},
	});

  // Make a tooltip
  hex.on('mouseover',function(e){
  	var svg,tip,bb,bbo,hex;
  	svg = e.data.hexmap.el;
  	hex = e.target;
  	// Get any existing tooltip for this hexmap
  	tip = svg.querySelector('.hex-tip');
  	if(!tip){
  		// Add a new tooltip
  		tip = document.createElement('div');
  		tip.classList.add('hex-tip');
  		svg.appendChild(tip);
  	}
  	// Update contents of tooltip
  	tip.innerHTML = '<a href="/systems/'+e.data.data.sys_id+'">'+e.data.data.n+'</a>'+
  	  '<br />'+'Traveller Coordinates '+e.data.data.hex_loc.toLocaleString()+
  	  '<br /> Hexmap Coordinates q:'+e.data.data.q+' r:'+e.data.data.r;
  	// Update position of tooltip
  	bb = hex.getBoundingClientRect();
  	bbo = svg.getBoundingClientRect();
  	tip.style.left = Math.round(bb.left + bb.width/2 - bbo.left + svg.scrollLeft)+'px';
  	tip.style.top = Math.round(bb.top + bb.height/2 - bbo.top -15)+'px';
  });

</script>
<% end %>