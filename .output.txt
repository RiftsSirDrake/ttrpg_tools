<%= form_for @system, url: @system.persisted? ? system_path(@system) : systems_path do |f| %>
  <% if @system.errors.any? %>
    <div id="error_explanation">
      <h2>
        <%= pluralize(@system.errors.count, "error") %> prohibited this system from being saved:
      </h2>
      <ul>
        <% @system.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <section class='section'>
    <div class='row'>
      <div class='col-lg-10'>
        <div class='card'>
          <div class='card-body'>
            <h5 class='card-title'>
              System located in: <%= @sector.name %> sector
              <%= f.hidden_field :sector_id, value: @sector.id %>
            </h5>
          <div>
            <div class="form-group">
              <%= f.label :name %>
              <%= f.text_field :name, maxlength: 45, class: 'form-control' %>
            </div>

            <div class="form-group">
              <%= f.label :location %> <small>(Ex. 0301 = third column, first row)</small>
              <%= f.number_field :location, class: 'form-control' %>
            </div>

            <div class="form-group">
              <%= f.label 'Port' %>
              <%= f.select :starport, options_for_select(Shared::SystemMapping::PORT_MAP.map { |k, v| [v, k] }, selected: @system.uwp[0]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Size' %>
              <%= f.select :planet_size, options_for_select(Shared::SystemMapping::SIZE_MAP.map { |k, v| [v, k] }, selected: @system.uwp[1]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Atmo' %>
              <%= f.select :atmosphere, options_for_select(Shared::SystemMapping::ATMO_MAP.map { |k, v| [v, k] }, selected: @system.uwp[2]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Hydro' %>
              <%= f.select :hydrosphere, options_for_select(Shared::SystemMapping::HYDRO_MAP.map { |k, v| [v, k] }, selected: @system.uwp[3]), {}, { class: "form-control" } %>
            </div>
            <div id="population">
              <div class="form-group">
                <%= f.label 'Pop Base' %>
                <%= f.select :pop_base, options_for_select((0..9).to_a, @system.pbg[0]), {}, { class: 'form-control' } %>
              </div>

              <div class="form-group">
                <%= f.label 'Pop' %>
                <%= f.select :population, options_for_select(Shared::SystemMapping::POP_MAP.map { |k, v| [v.call(@system.pbg[0]), k] }, selected: @system.uwp[4]), {}, { class: "form-control" } %>
              </div>
            </div>
            <div class="form-group">
              <%= f.label 'Gov' %>
              <%= f.select :goverment, options_for_select(Shared::SystemMapping::GOV_MAP.map { |k, v| [v, k] }, selected: @system.uwp[5]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'LAW' %>
              <%= f.select :law, options_for_select(Shared::SystemMapping::LAW_MAP.map { |k, v| [v, k] }, selected: @system.uwp[6]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Tech' %>
              <%= f.select :tech_level, options_for_select(Shared::SystemMapping::TECH_MAP.map { |k, v| [v, k] }, selected: @system.uwp[8]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Bases' %>
              <%= f.select :base, options_for_select(Shared::SystemMapping::BASES_MAP.map { |k, v| [v, k] },selected: @system.base[0]), { include_blank: true }, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Note 1' %>
              <%= f.select :notes1, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[0,2]), { include_blank: true },  { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Note 2' %>
              <%= f.select :notes2, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[3,2]), { include_blank: true }, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Note 3' %>
              <%= f.select :notes3, options_for_select(Shared::SystemMapping::NOTES_MAP.map { |k, v| [v, k] }, selected: @system.notes[6,2]), { include_blank: true }, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Travel Advisory' %>
              <%= f.select :ring, options_for_select(Shared::SystemMapping::ADVISORY_MAP.map { |k, v| [v, k] }, selected: @system.ring[0]), {}, { class: "form-control" } %>
            </div>

            <div class="form-group">
              <%= f.label 'Asteroid Belts' %>
              <%= f.select :asteroid_belts, options_for_select((0..9).to_a, @system.pbg[1]), {}, { class: 'form-control' } %>
            </div>

            <div class="form-group">
              <%= f.label 'Gas Giants' %>
              <%= f.select :gas_giants, options_for_select((0..9).to_a, @system.pbg[2]), {}, { class: 'form-control' } %>
            </div>

            <div class="form-group">
              <%= f.label 'Faction' %>
              <div class="input-group">
                <%= f.select :allegiance, options_for_select(@factions.map { |f| [f.name, f.name] }, selected: @system.allegiance), { include_blank: true }, { class: "form-control", id: "faction_select" } %>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newFactionModal">
                  New Faction
                </button>
              </div>
            </div>

            <div class='col-12'><%= f.submit class: 'btn btn-primary' %></div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </section>
<% end %>
<!-- Modal -->
<div class="modal fade" id="newFactionModal" tabindex="-1" aria-labelledby="newFactionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newFactionModalLabel">New Faction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: SectorModel::Faction.new, url: factions_path, id: "new_faction_form", local: false do |f| %>
          <%= f.hidden_field :sector_id, value: @sector.id %>
          <div class="mb-3">
            <%= f.label :name, class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true %>
          </div>
          <div class="mb-3">
            <%= f.label :description, class: "form-label" %>
            <%= f.text_area :description, class: "form-control" %>
          </div>
          <div class="mb-3">
            <%= f.label :color_code, class: "form-label" %>
            <%= f.text_field :color_code, id: 'color_picker_modal', class: "form-control" %>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveFactionBtn">Save Faction</button>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function(){
      $('#color_picker_modal').spectrum({
          preferredFormat: "rgb",
          showInput: true
      });
      $('#saveFactionBtn').on('click', function() {
          var btn = $(this);
          btn.prop('disabled', true);
          btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
          $('#new_faction_form').submit();
      });
      $('#new_faction_form').on('ajax:success', function(event) {
          var detail = event.detail;
          var data = detail[0];

          var newOption = new Option(data.name, data.name, true, true);
          $('#faction_select').append(newOption).trigger('change');

          $('#newFactionModal').modal('hide');
          $('#new_faction_form')[0].reset();

          // Reset button state
          $('#saveFactionBtn').prop('disabled', false).text('Save Faction');
      }).on('ajax:error', function(event) {
          alert('Error creating faction');
          $('#saveFactionBtn').prop('disabled', false).text('Save Faction');
      });
      $('#population').on('change', '#sector_model_system_pop_base', function(){
        var pop_base_value = $(this).val();
        if (pop_base_value !== '0') {
          $('#sector_model_system_population option').each(function(){
            var pop_value = $(this).val();
            if (pop_value !== '0') {
              $(this).text(pop_base_value + $(this).text().substring(1, $(this).text().length));
            }
          });
        } else {
          $('#sector_model_system_population').val("0")
        }
        });
      });
</script>